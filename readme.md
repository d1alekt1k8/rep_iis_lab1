# Описание проекта
Проект посвящён решению задачи классификации цен на мобильные телефоны. С имеющимся датасетом было проведено полноценное исследование, включащее разведочный анализ данных и многое другое. Результат "очищенного датасета" был сохранён для создания модели предсказания, а также был интерпретирован для различных выводов.

Была создана полноценная модель классификации цены мобильного телефона по входным параметрам. Для создания качественной модели были использованы такие библиотеки, как sklearn, optuna, autofeat и др. Сервисы, по типу mlflow, позволили качественно отслеживать результаты различных моделей и проводить их сравнение при помощи метрик.

На основе лучшей из созданных моделей был сделан сервис предсказаний, размещённый на FastAPI, работающий на uvicorn. Каталог ``` /services``` содержит в себе все файлы, необходимые для запуска контейнера и полного функционирования сервиса на выбранной модели.

Полученный сервис был протестирован и исследован при помощи технологий prometheus и grafana.

Исходные данные: https://www.kaggle.com/datasets/iabhishekofficial/mobile-price-classification?resource=download

# Запуск
Для запуска проекта необходимо выполнить следующие команды:

``` git clone https://github.com/d1alekt1k8/rep_iis_lab1.git ```

Открыть папку через функцию "Open Folder" в разделе File

Создать виртуальное окружение:
``` python3 -m venv .venv_lr1 ```

Активировать виртуальное окружение:
``` source .venv_lr1/bin/activate ```

Установка зависимостей:
``` pip install -r requirments.txt ```

Установить исходные данные и загрузить в папку ` ./data `

# Исследование данных
Находится в ``` ./eda/eda.ipynb ```

В ходе исследования были проведены действия:

- Признаки, описывающие наличие или отсутствие параметра, переведы в категориальный тип. Например:
``` df['blue'] = df['blue'].astype('category') ```
- Числовые признаки, содержащие небольшой диапазон чисел, получили меньший по объёму тип данных. Например:
``` df['fc'] = df['fc'].astype('int8') ```

- Удалены данные со значением ширины экрана меньше 3 см.
``` df = df.query('sc_w >= 3') ```

- Удалены данные со значением разрешения по высоте меньше 20 пикселей.
``` df = df.query('px_height >= 20') ```

В ходе анализа были выявлены следующие закономерности:

- Среди числовых признаков только у ёмкости аккумулятора, оперативной памяти и внутренней памяти наблюдается прямая корреляция с ценой: чем выше ёмкость и память, тем выше цена. (см график)
![graph1](/eda/graph1.png)

- Наличие Wi-Fi и 4g уменьшает время возможного разговора по телефону, то есть увеличивает разряд батареи. Наличие же сенсорного экрана и блютуза наоборот привело к улучшению мобильных устройств в целом и время разговора увеличилось. (см график)
![graph2](/eda/graph2.png)

- C увеличением размеров и разрешения экрана возрастает цена на телефон. (см график)
![graph3](/eda/graph3.png)

- Увеличение толщины телефона приводит к небольшому увеличению веса телефона, качества камеры, количества ядер и ёмкости баттареи. Увеличение толщины предполагает больше места в телефоне, следовательно можно "напихать" оборудования лучше. (см график ```./eda/graph4.png```)
![graph4](/eda/graph4.png)

- В рамках анализа был создан интерактивный график, который отображает зависимость между количеством ядер и объемом оперативной памяти для разных ценовых категорий мобильных устройств


# Запуск MLFlow

1. Перейти в директорию mlflow
```
cd mlflow
```

2. Выполинть в терминале следующую команду
```
source start_mlflow.sh
```


# Результаты исследования

Лучший результат показала модель на основе sklearn RFE:

- В качестве средства оценки - RandomForestClassifier
- Количество объектов оценки - 12
- Шаг - 12

Метрики лучшего прогона:
- precision: 0.9247977623211014
- recall: 0.925
- f1: 0.9248309911215962
```
run_id = "00e2896da20a49c0b8550c616efb28bd"
```
# Сервис классификации

Описание файлов в папке services:
- api_handler.py включает в себя функции, необходимые для работы модели в FastAPI (загрузка, обработка и т.п.)
- Dockerfile включает в себя необходимые команды для сборки контейнера с определёнными параметрами
- main.py содержит основные функции для создания предсказаний
- requirements.txt содержит необходимые для работы сервиса библиотеки
- файл get_model.py берёт необходимую модель из mlflow и записывает её в формат pickle
- model.pkl содержит модель, полученную в предыдушем пункте

Создание образа и запуск контейнера осуществляется по следующим командам:
```
docker build . --tag mobile_classifier_model:0
docker run -p 8001:8000 -v $(pwd)/../models:/models mobile_classifier_model:0
```

Проверить работоспособность сервиса можно следующей командой:
```
curl -X 'POST' \'http://localhost:8001/api/prediction?mobile_id=1' \-H 'accept: application/json' \-H 'Content-Type: application/json' \-d '{"battery_power":	842,"blue":	     0,"clock_speed":	2.2,"dual_sim":	0,"fc":	1,"four_g":	0,"int_memory":	7,"m_dep":	0.6,"mobile_wt":	188,"n_cores":	2,"pc":	  2,"px_height": 20,"px_width": 756,"ram": 2549,"sc_h": 9,"sc_w": 7,"talk_time": 19,"three_g": 0,"touch_screen": 0,"wifi": 1
}'
```

# Мониторинг

В рамках данного раздела был налажен веб-интерфейс prometheus, существующий для сбора и хранения метрик, генерируемых сервисами. Файл конфигурации и полученные скриншоты хранятся в соответствующей директории ```/services/prometheus ```. Доступ к веб-интерфейсу осуществляется по адресу ``` http://localhost:9090```.

В рамках тестирования интерфейса были полученные следующие скриншоты:

Гистограмма предсказаний модели
![prom_hist](/services/prometheus/Screenshot%20from%202024-12-17%2018-26-05.png)

Частота запросов к основному сервису
![prom_rate](/services/prometheus/Screenshot%20from%202024-12-17%2017-47-52.png)

Количество запросов к сервису с кодами ошибок 4** и 5**
![prom_error](/services/prometheus/Screenshot%20from%202024-12-17%2018-34-28.png)


# Дашборд

В рамках завершающего этапа были разработан сервис grafana.


Сервис, созданный для визуализации метрик путём создания дашбордов. Полученный в результате создания дашборд хранится в ``` services/grafana ```. Веб-интерфейс запускается по адресу ``` http://localhost:3000 ```. В качестве database используется сервис prometheus.

![Grafana Dashboard](/services/grafana/Screenshot%20from%202024-12-19%2001-32-48.png)

Описание метрик, полученных на дашборде выше:

1. prediction_histogram_bucket

Гистограмма, отображающая распределение предсказаний модели по классам. То есть она показывает, какие классы чаще предсказывает модель. 4 цвета на гистограмме соответствуют четырём "рангам" цен телефонов. Уровень мониторинга: Качество работы модели

2. process_cpu_seconds_total

Временной ряд, показывающий общее время работы процессора, затраченное на выполнение той или иной задачи. Полезна для определения загруженности процессора. Уровень мониторинга: Инфраструктурный уровень

3. prediction_request_latency_seconds_count

Диаграмма, показывающая количество измерений времени обработки запросов на предсказание. Полезна для определения задержки выполнения запроса. Уровень мониторинга: прикладной уровень.

4. model_data_shift

Датчик, показывающий сдвиг входных данных относительно данных, на которых обучалась модель. Может повлиять на точность модели. Уровень мониторинга: качество работы модели

5. model_accuracy

Датчик, показывающий точность предсказания модели. Уровень мониторинга: качество работы модели

6. prediction_requests_total

Временной ряд, показывающий количество полученных запросов. Уровень мониторинга: прикладной уровень.



# Итоговая команда для запуска compose-проекта

``` docker build . --tag mobile_classifier_model:2 ```

``` docker compose up ```